---
title: TCP
order: 2
---

# TCP

相信各位已经看过不少关于 TCP 协议的文章了，这里我们换种方式，以 **TCP 扮演的角色** 切入，给大家讲一下关于 TCP 你需要了解的一些东西。

## TCP 扮演的角色

TCP 协议在互联网中其实扮演了一个 **可靠和完整的数据传输者** 的角色，为什么？

通过 [OSI](https://en.wikipedia.org/wiki/OSI_model) 七层模型，我们知道互联网其实是由一整套协议构成的，

![image.png](https://i.loli.net/2020/07/21/dIPzXkMh25j9bOx.png)

而我们今天的主角，TCP 协议位于传输层，所以我们叫它 “数据传输者” 没啥问题。在 [上一篇]() 文章中，我们介绍了在传输层还有另一个扮演类似角色的协议，**UDP**，我们知道 UDP 是高效但不可靠的，所以作为补充，TCP 协议从一开始就被设计为 **完整和可靠的**。

**你可能会有疑惑为什么我们需要这样一个可靠的协议？**

这个问题还得从他的邻居说起。回到上图，我们发现 TCP 协议是以太网协议 (Ethernet) 和 IP 协议的上层协议，以太网协议和 IP 协议都干了什么事？

最底层的以太网协议规定了电子信号如何组成数据包（packet），所以基于以太网协议，我们可以实现局域网内的 **点对点通信**，

![image.png](https://i.loli.net/2020/07/21/z1VZyB7cpliTM9J.png)

但是以太网协议只能解决局域网内部的通信，局域网之间想要建立连接怎么办？**交给 IP 协议**。

IP 协议定义了一套地址规则，也就是我们说的 IP 地址，同时实现了 **路由** 的功能，允许某个局域网内的主机 A 想另一个局域网的主机 B 发送消息。有了 IP 协议，局域网之间互通就很简单了，我们只需要通过路由器（路由器就是 IP 协议的实现），在对应的网口插上网线，就可以实现数据转发。

而路由的原理其实很简单，路由器的内部维护了一张路由表，规定了每段 IP 地址的出口，也就是我们数据包到达的目的地，通过路由表，我们就可以知道数据包应该发送到哪个网口了。什么？你不知道路由器长啥样？

![image.png](https://i.loli.net/2020/07/22/dgSasO48mEGjtNz.png)

( 图片说明：路由器背后有很多网口，接入网线后，每一个网口就对应路由表内的一个数据包出口 )

故事还没有结束，IP 协议是一个地址协议，可以实现数据包的转发，但是数据通信远不止转发包这么简单，试想一下，

- 如果路由器缓存满了导致丢包了，该如何重发丢失的包？
- 怎么样保证数据包传输的完整性？
- 网络条件差的情况下，怎么样控制发包的速率，减少丢包？
- ... ...

所以，我们确实需要这么一个协议，来解决丢包的问题，保证数据通信的可靠和完整。而这个协议，就是 **TCP 协议**。

## 面向连接

我们之前讲通信技术大致可以分为三类：**面向连接的电路交换，面向连接的包交换，以及无连接的包交换**，TCP 在这里使用的是**面向连接的包交换**。

如何理解面向连接？

首先，为什么 TCP 协议使用面向连接的包交换的通信技术，相信大家已经有了答案，因为我们需要实现的是一个可靠的通信协议。

面向连接就意味着通信开始前，双方需要先建立连接，但是 TCP 其实是无连接的，为什么？

我们知道 HTTP 是无连接的，所以作为下层的 TCP 协议也是无连接的，虽然看似 TCP 将两端连接了起来，但是其实只是两端共同维护了一个状态。

这种面向连接的无连接很是让人困惑，想要理解 TCP 的这种状态机，得从建立和断开连接的过程说起。

### 建立连接

![image.png](https://i.loli.net/2020/07/22/vgH5bCKjsmuNTMt.png)

### 断开连接

![image.png](https://i.loli.net/2020/07/22/WP8RYONUaTpKZ9v.gif)

## 头部信息

### SEQ

### ACK

## ARQ

## 拥塞控制

### 慢启动

### 拥塞避免

### 快速重传

### 快速恢复
